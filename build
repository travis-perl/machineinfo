#!/bin/bash
set -e

git remote set-branches --add origin gh-pages
git fetch --all
git branch --track gh-pages origin/gh-pages
git clone --branch gh-pages $(pwd) ~/machineinfo

host="$(hostname -f)"
ref="$(git describe --all --long HEAD)"

(
  echo "# Machine Info"
  echo ""
  echo "## Kernel"
  cat /proc/version | sed -e's/^/    /'
  echo ""
  echo "## Hostname"
  echo "$host" | sed -e's/^/    /'
  echo ""
  echo "## Free memory"
  free -t -m | sed -e's/^/    /'
  echo ""
  echo "## Filesystem Info"
  df | sed -e's/^/    /'
  echo ""
  echo "## Environment"
  env | sort | grep -v '^SSH_KEY_PASS=' | sed -e's/^/    /'
  echo ""
  echo "## CPU Info"
  perl -e'my %p; my @p; while(<>) { s/\s+$//; /^([^:]+?)\s*:\s*(.*)/ or next; my ($k,$v) = ($1,$2); push @p, $k if !$p{$k}; push @{$p{$k}||=[]}, $v; } for (@p) { printf "%20s: ", $_; my %s; $s{$_}++ for @{$p{$_}}; if (1 == keys %s) { print $p{$_}[0] } else { print "[".join(",",@{$p{$_}})."]" } print "\n" }' /proc/cpuinfo | sed -e's/^/    /'
  echo ""
  echo "## Processes"
  ps auxwww | sed -e's/^/    /'
  echo ""
  echo "## Services"
  sudo service --status-all 2>&1 | sed -e's/^/    /'
) 2>&1 | tee ~/machineinfo/_includes/index.md

(
  export GIT_AUTHOR_NAME="$(git log -n 1 --format='%an')"
  export GIT_AUTHOR_EMAIL="$(git log -n 1 --format='%ae')"
  export GIT_COMMITTER_NAME="Travis CI"
  export GIT_COMMITTER_EMAIL="travis-ci@$host"

  cd ~/machineinfo
  git add _includes/index.md
  git commit -m"System info $host build with $ref"
  git push origin gh-pages
)

if [ -n "$TRAVIS_PULL_REQUEST" ] && [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
  exit 0
fi

current_branch="$(git symbolic-ref --short -q HEAD || echo "$TRAVIS_BRANCH")"
if [ "$current_branch" != "master" ]; then
  exit 0
fi

if [ ! -e id_rsa.dec ]; then
  cp id_rsa id_rsa.dec
  chmod 600 id_rsa.dec
  ssh-keygen -p -f id_rsa.dec -P "$SSH_KEY_PASS" -N '' || rm id_rsa.dec
fi

git config --replace-all url.git@github.com:.pushInsteadOf git://github.com/ '^git://github\.com/$'
git config --replace-all url.git@github.com:.pushInsteadOf https://github.com/ '^https://github\.com/$'

GIT_SSH=./ssh-wrapper git push origin gh-pages
